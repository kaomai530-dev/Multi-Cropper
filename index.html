<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Multi Cropper - 映画比率固定版</title>
    <style>
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --bg-dark: #1a1a2e;
            --panel-bg: #16213e;
            --text-light: #e9ecef;
        }

        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-light);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h1 { margin-bottom: 30px; font-weight: 300; letter-spacing: 2px; }

        /* プレビューコンテナ：ここがSafari攻略の要 */
        .preview-container {
            width: 100%;
            max-width: 800px;
            margin: 20px auto;
            background: #000;
            position: relative;
            /* 1920:818 (約42.604%) の比率を物理的に強制確保 */
            padding-top: 42.60416%; 
            border-radius: 8px;
            border: 2px solid rgba(102, 126, 234, 0.3);
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        #croppedPreview {
            position: absolute;
            top: 0;
            left: 0;
            width: 100% !important;
            height: 100% !important;
            /* 歪ませず、黒枠を維持して収める */
            object-fit: contain !important;
            background-color: #000;
            display: block;
        }

        .label-tag {
            margin-top: 10px;
            font-size: 0.9rem;
            color: #8892b0;
        }

        /* クロップ操作エリア（既存のデザインを継承） */
        .editor-container {
            width: 100%;
            max-width: 1000px;
            background: var(--panel-bg);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
        }

        .canvas-wrapper {
            position: relative;
            width: 100%;
            background: #000;
            margin-bottom: 20px;
            overflow: hidden;
            cursor: move;
            touch-action: none;
        }

        canvas { display: block; max-width: 100%; height: auto; margin: 0 auto; }

        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        button {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        button:active { transform: scale(0.95); }

        input[type="file"] { display: none; }
        
        .upload-label {
            display: inline-block;
            padding: 15px 30px;
            background: #233554;
            border: 2px dashed var(--primary-color);
            border-radius: 10px;
            cursor: pointer;
            margin-bottom: 20px;
        }

        #croppedCanvas { display: none; } /* 計算用隠しキャンバス */

    </style>
</head>
<body>

    <h1>MULTI CROPPER</h1>

    <label class="upload-label" for="fileInput">画像をアップロード</label>
    <input type="file" id="fileInput" accept="image/*">

    <div class="editor-container" id="editorArea" style="display:none;">
        <div class="canvas-wrapper" id="canvasWrapper">
            <canvas id="mainCanvas"></canvas>
        </div>
        
        <div class="controls">
            <button id="zoomIn">拡大 (+)</button>
            <button id="zoomOut">縮小 (-)</button>
            <button id="resetBtn">リセット</button>
            <button id="downloadBtn" style="background:#28a745;">保存する</button>
        </div>
    </div>

    <div id="previewSection" style="display:none; width:100%; text-align:center;">
        <div class="label-tag" id="croppedLabel">クロップ後（1920 × 818）</div>
        <div class="preview-container">
            <img id="croppedPreview" alt="Preview">
        </div>
    </div>

    <canvas id="croppedCanvas"></canvas>

    <script>
        const fileInput = document.getElementById('fileInput');
        const mainCanvas = document.getElementById('mainCanvas');
        const ctx = mainCanvas.getContext('2d');
        const preview = document.getElementById('croppedPreview');
        const editorArea = document.getElementById('editorArea');
        const previewSection = document.getElementById('previewSection');

        let img = new Image();
        let zoomLevel = 1.0;
        let panX = 0;
        let panY = 0;
        let isDragging = false;
        let startX, startY;

        // 設定：1920x818
        const TARGET_W = 1920;
        const TARGET_H = 818;

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                img.onload = () => {
                    editorArea.style.display = 'block';
                    previewSection.style.display = 'block';
                    initEditor();
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        });

        function initEditor() {
            // 表示用キャンバスの初期設定
            const containerWidth = document.getElementById('canvasWrapper').clientWidth;
            mainCanvas.width = containerWidth;
            mainCanvas.height = containerWidth * (TARGET_H / TARGET_W);
            
            zoomLevel = 1.0;
            panX = 0;
            panY = 0;
            draw();
        }

        function draw() {
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, mainCanvas.width, mainCanvas.height);

            const displayW = mainCanvas.width * zoomLevel;
            const displayH = (mainCanvas.width * (img.naturalHeight / img.naturalWidth)) * zoomLevel;
            
            const x = (mainCanvas.width - displayW) / 2 + panX;
            const y = (mainCanvas.height - displayH) / 2 + panY;

            ctx.drawImage(img, x, y, displayW, displayH);
            updateRealCrop();
        }

        function updateRealCrop() {
            const outCanvas = document.getElementById('croppedCanvas');
            const outCtx = outCanvas.getContext('2d');
            outCanvas.width = TARGET_W;
            outCanvas.height = TARGET_H;

            // 計算：表示用キャンバスから1920x818へのスケール変換
            const scale = TARGET_W / mainCanvas.width;
            
            outCtx.fillStyle = '#000';
            outCtx.fillRect(0, 0, TARGET_W, TARGET_H);

            const drawW = (mainCanvas.width * zoomLevel) * scale;
            const drawH = ((mainCanvas.width * (img.naturalHeight / img.naturalWidth)) * zoomLevel) * scale;
            const drawX = ((mainCanvas.width - (mainCanvas.width * zoomLevel)) / 2 + panX) * scale;
            const drawY = ((mainCanvas.height - ((mainCanvas.width * (img.naturalHeight / img.naturalWidth)) * zoomLevel)) / 2 + panY) * scale;

            outCtx.drawImage(img, drawX, drawY, drawW, drawH);

            // Safariのバグ回避用：再描画トリガー
            const dataUrl = outCanvas.toDataURL('image/png');
            preview.style.display = 'none'; // 一旦消す
            preview.src = "";
            
            setTimeout(() => {
                preview.src = dataUrl;
                preview.style.display = 'block';
            }, 10);
        }

        // イベント：ドラッグ移動
        mainCanvas.addEventListener('mousedown', startDrag);
        mainCanvas.addEventListener('touchstart', (e) => startDrag(e.touches[0]));

        function startDrag(e) {
            isDragging = true;
            startX = e.clientX - panX;
            startY = e.clientY - panY;
        }

        window.addEventListener('mousemove', drag);
        window.addEventListener('touchmove', (e) => drag(e.touches[0]));

        function drag(e) {
            if (!isDragging) return;
            panX = e.clientX - startX;
            panY = e.clientY - startY;
            draw();
        }

        window.addEventListener('mouseup', () => isDragging = false);
        window.addEventListener('touchend', () => isDragging = false);

        // ズーム
        document.getElementById('zoomIn').onclick = () => { zoomLevel *= 1.1; draw(); };
        document.getElementById('zoomOut').onclick = () => { zoomLevel /= 1.1; draw(); };
        document.getElementById('resetBtn').onclick = () => initEditor();

        // ダウンロード
        document.getElementById('downloadBtn').onclick = () => {
            const link = document.createElement('a');
            link.download = 'cropped_1920x818.png';
            link.href = document.getElementById('croppedCanvas').toDataURL();
            link.click();
        };

    </script>
</body>
</html>
